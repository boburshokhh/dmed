# План исправления проблем с QR-кодом на Ubuntu сервере

## Выявленные проблемы

### 1. QR код использует старую библиотеку
**Проблема:** В `utils.py` используется библиотека `qrcode-styled`, но она отсутствует в `requirements.txt`. На Ubuntu сервере она не установлена, поэтому код падает в fallback на обычный `qrcode`, который может работать по-другому.

**Решение:**
- Добавить `qrcode-styled` в `requirements.txt` с указанием версии
- Или улучшить fallback-логику для работы с обычным `qrcode`
- Добавить логирование для диагностики

### 2. Расположение QR-кода и PIN-кода не соответствует
**Проблема:** На Ubuntu сервере расположение PIN-кода и QR-кода может отличаться от ожидаемого.

**Возможные причины:**
- Различия в версиях библиотек (python-docx, Pillow)
- Проблемы с отступами в таблице (отрицательные отступы могут работать по-разному)
- Различия в рендеринге DOCX между Windows и Linux

**Решение:**
- Улучшить логирование для диагностики
- Исправить отступы в таблице (использовать положительные значения)
- Добавить проверку порядка ячеек в таблице
- Улучшить выравнивание элементов

## План действий

### ✅ Шаг 1: Исправить библиотеку QR-кода (ВЫПОЛНЕНО)
1. ✅ Добавлен `qrcode-styled>=0.2.0` в `requirements.txt`
2. ✅ Улучшена fallback-логика с подробным логированием
3. ✅ Добавлено подробное логирование в `generate_qr_code()`

### ✅ Шаг 2: Исправить расположение PIN и QR (ВЫПОЛНЕНО)
1. ✅ Проверен порядок ячеек в таблице (PIN в ячейке 0 слева, QR в ячейке 1 справа)
2. ✅ Исправлены отступы (заменены отрицательные значения на нулевые для совместимости)
3. ✅ Улучшено выравнивание элементов
4. ✅ Добавлено подробное логирование в `add_qr_code_to_docx()` и `create_pin_qr_table()`

### ✅ Шаг 3: Добавить диагностику (ВЫПОЛНЕНО)
1. ✅ Добавлено логирование в `generate_qr_code()` с информацией о библиотеке
2. ✅ Добавлено логирование в `add_qr_code_to_docx()` с информацией о процессе
3. ✅ Добавлено логирование создания таблиц и размещения элементов

## Что было исправлено

### Файл `requirements.txt`
- Добавлена библиотека `qrcode-styled>=0.2.0` для генерации QR-кодов со стилем

### Файл `utils.py`
- Улучшено логирование в функции `generate_qr_code()`
- Добавлены сообщения о том, какая библиотека используется
- Улучшена обработка ошибок с подробным логированием

### Файл `document_generator.py`
- **Исправлены отрицательные отступы**: заменены на нулевые для совместимости между Windows и Ubuntu
- **Добавлено логирование**:
  - Логи начала и конца процесса добавления QR-кода
  - Логи создания таблиц с указанием размеров колонок
  - Логи размещения PIN-кода и QR-кода в ячейках
  - Логи установки отступов
- **Исправлены отступы в двух местах**:
  1. В функции `create_pin_qr_table()` (основная таблица)
  2. В функции `replace_qr_placeholder()` (вложенная таблица в ячейке)

## Как помочь с диагностикой

### После применения исправлений:

1. **Установите новую библиотеку:**
   ```bash
   pip install -r requirements.txt
   ```
   Или конкретно:
   ```bash
   pip install qrcode-styled>=0.2.0
   ```

2. **Проверьте установленные библиотеки:**
   ```bash
   pip list | grep -E "qrcode|Pillow|python-docx"
   ```
   Должны быть:
   - `qrcode==7.4.2`
   - `qrcode-styled>=0.2.0` (новая!)
   - `Pillow==10.1.0`
   - `python-docx==1.1.0`

3. **Тестовый запуск:**
   ```bash
   python test_qr_generation.py
   python test_document_qr.py
   ```

4. **Логи для предоставления (при проблемах):**
   - Ищите строки с `[QR_CODE]` - информация о генерации QR-кода
   - Ищите строки с `[QR_PIN_LAYOUT]` - информация о размещении PIN и QR
   - Ищите строки с `[WARNING]` - предупреждения
   - Ищите строки с `[ERROR]` - ошибки

5. **Логи Flask приложения:**
   - Все сообщения при генерации документа
   - Ошибки и предупреждения
   - Особенно важны строки с префиксами `[QR_CODE]` и `[QR_PIN_LAYOUT]`

### Что проверить на сервере:
1. ✅ Версия Python (`python --version`)
2. ✅ Установленные библиотеки (`pip list`)
3. ✅ Логи приложения при генерации документа (ищите `[QR_CODE]` и `[QR_PIN_LAYOUT]`)
4. ✅ Пример сгенерированного документа (для проверки расположения)

### Примеры логов, которые нужно искать:

**Успешная генерация:**
```
[QR_CODE] Начинаем генерацию QR-кода для URL: https://...
[QR_CODE] Используем библиотеку qrcode-styled
[QR_CODE] Логотип создан, размер: (200, 200)
[QR_CODE] QR-код сгенерирован через qrcode-styled, тип: <class 'PIL.Image.Image'>
[QR_PIN_LAYOUT] ===== Начало добавления QR-кода и PIN-кода =====
[QR_PIN_LAYOUT] PIN-код: 1234, UUID: ...
[QR_PIN_LAYOUT] Таблица создана: PIN слева (ячейка 0), QR справа (ячейка 1)
```

**Если используется fallback:**
```
[WARNING] qrcode-styled не установлен (...), используем обычный qrcode
[QR_CODE] Используем fallback: обычный qrcode
```

## Ожидаемый результат

После исправлений:
- ✅ QR-код генерируется с правильной библиотекой
- ✅ PIN-код расположен слева от QR-кода
- ✅ Правильное выравнивание и отступы
- ✅ Работает одинаково на Windows и Ubuntu

