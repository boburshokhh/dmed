# Исправление размещения QR-кода и PIN-кода в ячейке таблицы

## Проблема

Когда в одной ячейке таблицы находились и `{{pin_code}}` и `{{qr_code}}`, они накладывались друг на друга:
- QR-код отображался поверх PIN-кода
- PIN-код был не виден или частично скрыт
- Элементы не были расположены горизонтально

## Причина проблемы

Функция `replace_qr_placeholder()` в `document_generator.py`:
1. Находила плейсхолдер `{{qr_code}}` в параграфе
2. Очищала весь параграф (`paragraph.clear()`)
3. Добавляла только QR-код
4. Это удаляло PIN-код, который уже был заменен в том же параграфе/ячейке

## Решение

Исправлена функция `replace_qr_placeholder()` для правильного горизонтального размещения:

### 1. Обнаружение PIN-кода в ячейке (строки 826-859)

Функция теперь проверяет, есть ли PIN-код в той же ячейке таблицы:
- Ищет уже замененный PIN-код (4 цифры)
- Проверяет наличие плейсхолдера `{{pin_code}}`
- Ищет текст "PIN" или "код" с цифрами
- Использует переданный параметр `pin_code` для сравнения

### 2. Горизонтальное размещение (строки 861-892)

Если PIN-код найден в ячейке:
1. **Очищает ячейку** - удаляет все параграфы для чистого размещения
2. **Создает новый параграф** - для размещения обоих элементов
3. **Добавляет PIN-код слева**:
   - Формат: `PIN: XXXX`
   - Жирный шрифт (bold)
   - Размер: 20pt
4. **Добавляет разделитель** - неразрывные пробелы (`\u00A0`) для отступа
5. **Добавляет QR-код справа**:
   - Размер: 1.2 дюйма
   - Расположен после PIN-кода
6. **Центрирует содержимое** - выравнивание по центру ячейки

### 3. Обновлены вызовы функции (строки 897, 919, 942)

Все вызовы `replace_qr_placeholder()` в таблицах теперь передают параметр `cell=cell`:
- Обычные таблицы документа
- Таблицы в header
- Таблицы в footer

## Результат

✅ **PIN-код слева, QR-код справа** - правильное горизонтальное размещение

✅ **Нет наложения** - элементы не перекрывают друг друга

✅ **Читаемость** - PIN-код виден и четко отформатирован

✅ **Центрирование** - содержимое центрировано в ячейке

## Как использовать в шаблоне

### Вариант 1: В одной ячейке таблицы

В шаблоне DOCX создайте таблицу и в одной ячейке разместите:

```
PIN: {{pin_code}}  {{qr_code}}
```

Или просто:

```
{{pin_code}}  {{qr_code}}
```

**Результат:** PIN-код будет слева, QR-код справа, горизонтально расположены.

### Вариант 2: Раздельные ячейки

Если нужны отдельные ячейки:

| PIN-код | QR-код |
|---------|--------|
| `{{pin_code}}` | `{{qr_code}}` |

**Результат:** Каждый элемент в своей ячейке.

## Технические детали

### Размеры и форматирование

- **PIN-код:**
  - Шрифт: жирный (bold)
  - Размер: 20pt
  - Формат: `PIN: XXXX`

- **QR-код:**
  - Размер: 1.2 дюйма (Inches(1.2))
  - Формат: PNG изображение

- **Разделитель:**
  - 15 неразрывных пробелов (`\u00A0`)
  - Обеспечивает отступ между элементами

### Логирование

Функция выводит в консоль:
- `[QR_CODE] QR-код и PIN-код размещены горизонтально в ячейке таблицы (PIN: XXXX)` - при успешном размещении
- `[QR_CODE] Ошибка при размещении QR и PIN в ячейке: ...` - при ошибке

## Обратная совместимость

✅ **Работает без PIN-кода** - если в ячейке только `{{qr_code}}`, он добавляется как обычно

✅ **Работает вне таблиц** - в обычных параграфах QR-код добавляется стандартным способом

✅ **Не ломает существующие шаблоны** - если PIN и QR в разных ячейках, все работает как раньше

## Примеры

### Пример 1: Таблица с PIN и QR в одной ячейке

**Шаблон:**
```
┌─────────────────────────────┐
│ PIN: {{pin_code}} {{qr_code}} │
└─────────────────────────────┘
```

**Результат:**
```
┌─────────────────────────────┐
│  PIN: 1234    [QR-код]      │
└─────────────────────────────┘
```

### Пример 2: Таблица с раздельными ячейками

**Шаблон:**
```
┌──────────┬──────────┐
│ {{pin_code}} │ {{qr_code}} │
└──────────┴──────────┘
```

**Результат:**
```
┌──────────┬──────────┐
│   1234   │ [QR-код] │
└──────────┴──────────┘
```

## Отладка

Если размещение не работает:

1. **Проверьте логи** - ищите сообщения `[QR_CODE]` в консоли
2. **Убедитесь, что PIN-код в той же ячейке** - функция ищет PIN только в той же ячейке, где находится QR
3. **Проверьте формат PIN-кода** - должен быть 4 цифры или содержать текст "PIN" или "код"
4. **Проверьте плейсхолдеры** - должны быть `{{pin_code}}` и `{{qr_code}}` (регистронезависимо)

## Дальнейшие улучшения

Возможные улучшения в будущем:
- Использование таблицы внутри ячейки для более точного контроля размещения
- Настройка размеров через параметры
- Поддержка вертикального размещения (PIN сверху, QR снизу)
- Настройка расстояния между элементами







