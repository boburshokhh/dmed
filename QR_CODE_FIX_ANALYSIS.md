# Анализ проблемы с QR-кодом в шаблонах

## Проблема

QR-код добавлялся в документ даже когда в шаблоне **не было** плейсхолдера `{{qr_code}}`. Это происходило из-за логики в функции `add_qr_code_to_docx()` в файле `document_generator.py`.

## Причина проблемы

В функции `add_qr_code_to_docx()` (строки 695-911) была следующая логика:

1. Функция искала плейсхолдер `{{qr_code}}` в документе
2. Если плейсхолдер **найден** → заменяла его на изображение QR-кода
3. Если плейсхолдер **НЕ найден** → **все равно добавляла QR-код в конец документа** (строки 805-809 старой версии)

Это означало, что QR-код всегда добавлялся, независимо от наличия плейсхолдера в шаблоне.

## Решение

Исправлена функция `add_qr_code_to_docx()` следующим образом:

### 1. Предварительная проверка наличия плейсхолдера

Функция теперь **сначала проверяет**, есть ли плейсхолдер `{{qr_code}}` в документе (включая все варианты написания):
- `{{qr_code}}`
- `{{QR_CODE}}`
- `{{Qr_Code}}`
- `{{QR code}}`
- `{{qr code}}`

Проверка выполняется во всех частях документа:
- Обычные параграфы
- Таблицы
- Колонтитулы (header/footer)

### 2. Ранний выход при отсутствии плейсхолдера

Если плейсхолдер **не найден**, функция **сразу выходит** без генерации и добавления QR-кода:

```python
# Если плейсхолдер не найден, выходим без добавления QR-кода
if not qr_placeholder_found:
    print(f"[INFO] Плейсхолдер {{qr_code}} не найден в шаблоне. QR-код не будет добавлен.")
    return
```

### 3. Удален код принудительного добавления

Удален код, который добавлял QR-код в конец документа, если плейсхолдер не был найден при замене. Теперь если плейсхолдер был найден, но не удалось его заменить, выводится только предупреждение в лог.

## Как использовать

### Для добавления QR-кода в документ:

1. В шаблоне DOCX добавьте плейсхолдер в нужном месте:
   ```
   {{qr_code}}
   ```
   или любой другой вариант:
   ```
   {{QR_CODE}}
   {{Qr_Code}}
   {{QR code}}
   ```

2. При генерации документа QR-код автоматически заменит плейсхолдер на изображение QR-кода.

### Для документов без QR-кода:

1. Просто **не добавляйте** плейсхолдер `{{qr_code}}` в шаблон
2. QR-код **не будет** добавлен в документ

## Технические детали

### Изменения в коде:

1. **Добавлена предварительная проверка** (строки 698-786):
   - Функция `check_for_qr_placeholder()` проверяет наличие плейсхолдера
   - Проверка выполняется во всех частях документа до генерации QR-кода

2. **Ранний выход** (строки 783-786):
   - Если плейсхолдер не найден, функция возвращается без генерации QR-кода

3. **Улучшенная функция замены** (строки 816-830):
   - Поддерживает все варианты написания плейсхолдера
   - Регистронезависимый поиск

4. **Удален принудительный код** (старые строки 805-809):
   - Больше не добавляется QR-код в конец документа при отсутствии плейсхолдера

## Результат

✅ **QR-код добавляется** только если в шаблоне есть плейсхолдер `{{qr_code}}` (или его варианты)

✅ **QR-код НЕ добавляется** если плейсхолдера нет в шаблоне

✅ **Поддержка различных вариантов** написания плейсхолдера (регистронезависимо)

✅ **Логирование** для отладки (информационные сообщения и предупреждения)

## Примеры использования

### Пример 1: Документ с QR-кодом

**Шаблон:**
```
Документ № {{doc_number}}
PIN-код: {{pin_code}}

QR-код для проверки:
{{qr_code}}
```

**Результат:** QR-код будет добавлен на место плейсхолдера `{{qr_code}}`

### Пример 2: Документ без QR-кода

**Шаблон:**
```
Документ № {{doc_number}}
PIN-код: {{pin_code}}
```

**Результат:** QR-код НЕ будет добавлен в документ

## Проверка работы

После применения исправления:

1. Создайте документ с плейсхолдером `{{qr_code}}` → QR-код должен появиться
2. Создайте документ без плейсхолдера `{{qr_code}}` → QR-код НЕ должен появиться
3. Проверьте логи на наличие сообщений:
   - `[INFO] Плейсхолдер {{qr_code}} не найден в шаблоне. QR-код не будет добавлен.` (если плейсхолдера нет)

