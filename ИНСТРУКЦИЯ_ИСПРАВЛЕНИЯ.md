# Инструкция по исправлению проблем с QR-кодом на Ubuntu сервере

## Что было исправлено

### Проблема 1: QR код использует старую библиотеку ✅
**Исправлено:**
- Добавлена библиотека `qrcode-styled` в `requirements.txt`
- Улучшена fallback-логика (если библиотека не установлена, используется обычный `qrcode`)
- Добавлено подробное логирование для диагностики

### Проблема 2: Расположение QR-кода и PIN-кода не соответствует ✅
**Исправлено:**
- Убраны отрицательные отступы (заменены на нулевые для совместимости между Windows и Ubuntu)
- Исправлено расположение в основной таблице и во вложенной таблице
- Добавлено логирование для отслеживания процесса размещения

## Что нужно сделать на сервере

### 1. Установить новую библиотеку

```bash
# Перейдите в директорию проекта
cd /path/to/dmed

# Установите зависимости (включая новую библиотеку)
pip install -r requirements.txt

# Или установите конкретно:
pip install qrcode-styled>=0.2.0
```

### 2. Проверить установку

```bash
pip list | grep qrcode
```

Должны быть:
- `qrcode==7.4.2`
- `qrcode-styled>=0.2.0` ← **это новая библиотека**

### 3. Перезапустить приложение

```bash
# Остановите текущее приложение (если запущено)
# Затем запустите заново
python app.py
# или используйте ваш способ запуска (systemd, supervisor и т.д.)
```

## Как проверить, что исправления работают

### 1. Сгенерируйте тестовый документ

Создайте документ через интерфейс и проверьте:
- QR-код должен быть справа от PIN-кода
- PIN-код должен быть слева от QR-кода
- Оба элемента должны быть на одной линии

### 2. Проверьте логи

В логах приложения ищите строки с префиксами:
- `[QR_CODE]` - информация о генерации QR-кода
- `[QR_PIN_LAYOUT]` - информация о размещении PIN и QR

**Пример успешных логов:**
```
[QR_CODE] Начинаем генерацию QR-кода для URL: https://...
[QR_CODE] Используем библиотеку qrcode-styled
[QR_PIN_LAYOUT] ===== Начало добавления QR-кода и PIN-кода =====
[QR_PIN_LAYOUT] PIN-код: 1234, UUID: ...
[QR_PIN_LAYOUT] Таблица создана: PIN слева (ячейка 0), QR справа (ячейка 1)
[QR_PIN_LAYOUT] ===== Завершение добавления QR-кода и PIN-кода =====
```

**Если используется fallback (библиотека не установлена):**
```
[WARNING] qrcode-styled не установлен (...), используем обычный qrcode
[QR_CODE] Используем fallback: обычный qrcode
```

## Если проблемы остались

### Что предоставить для диагностики:

1. **Логи приложения:**
   - Все строки с `[QR_CODE]`
   - Все строки с `[QR_PIN_LAYOUT]`
   - Все строки с `[WARNING]` и `[ERROR]`

2. **Информация о системе:**
   ```bash
   python --version
   pip list | grep -E "qrcode|Pillow|python-docx"
   ```

3. **Тестовый запуск:**
   ```bash
   python test_qr_generation.py
   python test_document_qr.py
   ```
   Пришлите вывод этих команд

4. **Пример сгенерированного документа:**
   - Скриншот или сам документ (для проверки расположения)

## Измененные файлы

1. `requirements.txt` - добавлена библиотека `qrcode-styled`
2. `utils.py` - улучшено логирование в `generate_qr_code()`
3. `document_generator.py` - исправлены отступы и добавлено логирование

## Дополнительная информация

Подробный план исправлений находится в файле `UBUNTU_QR_FIX_PLAN.md`

