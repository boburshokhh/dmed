# Инструкция по перезапуску приложения после обновления

## Шаг 1: Проверьте, как запущено приложение

Выполните одну из команд ниже, чтобы понять, как запущено ваше приложение:

```bash
# Проверка через systemd
systemctl status dmed
# или
systemctl status flask-dmed
# или
systemctl status python-dmed

# Проверка через supervisor
supervisorctl status

# Проверка через ps (процессы Python)
ps aux | grep "python.*app.py"
ps aux | grep gunicorn
ps aux | grep uwsgi

# Проверка через screen/tmux
screen -ls
tmux ls
```

## Шаг 2: Перезапуск в зависимости от способа запуска

### Вариант A: Если приложение запущено через systemd

```bash
# Перезапуск службы
sudo systemctl restart dmed
# или
sudo systemctl restart flask-dmed
# или
sudo systemctl restart python-dmed

# Проверка статуса
sudo systemctl status dmed

# Просмотр логов
sudo journalctl -u dmed -f
# или
sudo journalctl -u flask-dmed -f
```

### Вариант B: Если приложение запущено через supervisor

```bash
# Перезапуск
supervisorctl restart dmed
# или
supervisorctl restart all

# Проверка статуса
supervisorctl status

# Просмотр логов
supervisorctl tail -f dmed
```

### Вариант C: Если приложение запущено через screen/tmux

**Для screen:**
```bash
# Список сессий
screen -ls

# Подключиться к сессии (замените PID на номер из screen -ls)
screen -r PID

# Внутри screen:
# Нажмите Ctrl+C чтобы остановить приложение
# Затем запустите заново:
source venv/bin/activate
python app.py

# Выйти из screen: Ctrl+A, затем D
```

**Для tmux:**
```bash
# Список сессий
tmux ls

# Подключиться к сессии
tmux attach -t session_name

# Внутри tmux:
# Нажмите Ctrl+C чтобы остановить приложение
# Затем запустите заново:
source venv/bin/activate
python app.py

# Выйти из tmux: Ctrl+B, затем D
```

### Вариант D: Если приложение запущено через gunicorn/uwsgi

```bash
# Найти процесс
ps aux | grep gunicorn
ps aux | grep uwsgi

# Остановить процесс (замените PID на номер процесса)
kill -HUP PID
# или
kill PID

# Запустить заново (используйте ваш скрипт запуска)
# Например:
source venv/bin/activate
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

### Вариант E: Если приложение запущено вручную (nohup или просто в терминале)

```bash
# Найти процесс
ps aux | grep "python.*app.py"

# Остановить процесс (замените PID на номер процесса)
kill PID

# Запустить заново
cd /var/www/dmed
source venv/bin/activate
nohup python app.py > app.log 2>&1 &
# или просто
python app.py
```

## Шаг 3: Проверка, что изменения применились

### 1. Проверьте, что библиотека установлена

```bash
source venv/bin/activate
pip list | grep qrcode-styled
```

Должно показать:
```
qrcode-styled         0.2.0    (или выше)
```

### 2. Проверьте логи при запуске

После перезапуска проверьте логи на наличие сообщений о QR-коде:

```bash
# Если через systemd
sudo journalctl -u dmed -n 50

# Если через supervisor
supervisorctl tail -f dmed

# Если через nohup
tail -f app.log

# Если просто в терминале - смотрите вывод в консоли
```

Ищите строки:
- `[QR_CODE]` - информация о генерации QR-кода
- `[QR_PIN_LAYOUT]` - информация о размещении PIN и QR

### 3. Протестируйте генерацию документа

1. Создайте тестовый документ через интерфейс
2. Проверьте, что:
   - QR-код генерируется правильно
   - PIN-код расположен слева от QR-кода
   - QR-код расположен справа от PIN-кода

### 4. Проверьте версию кода

```bash
cd /var/www/dmed
git log -1 --oneline
```

Должна быть последняя версия с исправлениями.

## Шаг 4: Если что-то пошло не так

### Проблема: Приложение не запускается

```bash
# Проверьте логи ошибок
sudo journalctl -u dmed -n 100
# или
tail -100 app.log

# Попробуйте запустить вручную для диагностики
cd /var/www/dmed
source venv/bin/activate
python app.py
```

### Проблема: Библиотека не установилась

```bash
source venv/bin/activate
pip install qrcode-styled>=0.2.0
pip install -r requirements.txt
```

### Проблема: Изменения не применились

```bash
# Убедитесь, что код обновлен
git status
git log -1

# Перезапустите приложение еще раз
# (используйте команды из Шага 2)
```

## Быстрая команда для перезапуска (универсальная)

Если вы не уверены, как запущено приложение, попробуйте:

```bash
# 1. Найти процесс
ps aux | grep "python.*app.py" | grep -v grep

# 2. Остановить (замените PID)
kill PID

# 3. Запустить заново
cd /var/www/dmed
source venv/bin/activate
nohup python app.py > app.log 2>&1 &

# 4. Проверить, что запустилось
ps aux | grep "python.*app.py" | grep -v grep
tail -f app.log
```

## Проверка успешного применения изменений

После перезапуска в логах должны появиться сообщения:

```
[QR_CODE] Начинаем генерацию QR-кода для URL: ...
[QR_CODE] Используем библиотеку qrcode-styled
[QR_PIN_LAYOUT] ===== Начало добавления QR-кода и PIN-кода =====
[QR_PIN_LAYOUT] Таблица создана: PIN слева (ячейка 0), QR справа (ячейка 1)
```

Если видите эти сообщения - изменения успешно применены! ✅

