# Тестирование исправлений QR-кода

## Текущий статус

✅ Приложение перезапущено
✅ Код обновлен (fallback исправлен)

## Что нужно сделать сейчас

### 1. Проверьте, установлена ли библиотека qrcode-styled

```bash
source venv/bin/activate
pip list | grep qrcode-styled
```

Если библиотека не установлена, установите:
```bash
pip install qrcode-styled>=0.2.0
sudo systemctl restart dmed
```

### 2. Сгенерируйте тестовый документ

1. Откройте интерфейс создания документа
2. Заполните форму
3. Нажмите "Создать документ"

### 3. Следите за логами в реальном времени

В другом терминале выполните:
```bash
sudo journalctl -u dmed -f
```

Или если уже следите - просто сгенерируйте документ.

## Что должно появиться в логах

### Если qrcode-styled установлен:
```
[QR_CODE] Начинаем генерацию QR-кода для URL: https://...
[QR_CODE] Используем библиотеку qrcode-styled
[QR_CODE] Логотип создан, размер: (200, 200)
[QR_CODE] QR-код сгенерирован через qrcode-styled
[QR_PIN_LAYOUT] ===== Начало добавления QR-кода и PIN-кода =====
[QR_PIN_LAYOUT] Таблица создана: PIN слева (ячейка 0), QR справа (ячейка 1)
```

### Если qrcode-styled НЕ установлен (fallback):
```
[QR_CODE] Начинаем генерацию QR-кода для URL: https://...
[WARNING] qrcode-styled не установлен (...), используем обычный qrcode
[QR_CODE] Используем fallback: обычный qrcode
[QR_CODE] Базовый QR-код создан, размер: (290, 290)
[QR_CODE] Логотип для вставки создан, размер: (63, 63)
[QR_CODE] Логотип вставлен в QR-код
[QR_CODE] Финальный QR-код (fallback): размер (290, 290), режим RGBA
[QR_PIN_LAYOUT] ===== Начало добавления QR-кода и PIN-кода =====
[QR_PIN_LAYOUT] Таблица создана: PIN слева (ячейка 0), QR справа (ячейка 1)
```

## Что НЕ должно появляться

❌ `[ERROR] Ошибка при добавлении QR-кода: 'NoneType' object has no attribute 'save'`
❌ `[QR_PIN_LAYOUT] QR-код сгенерирован, размер: None`

## Проверка результата

После генерации документа проверьте:

1. **Документ создан** - файл должен быть в системе
2. **QR-код присутствует** - в документе должен быть QR-код
3. **PIN-код слева, QR-код справа** - правильное расположение
4. **Нет ошибок в логах** - все должно работать без ошибок

## Если что-то не работает

1. Проверьте логи полностью:
   ```bash
   sudo journalctl -u dmed -n 200 | grep -E "QR_CODE|QR_PIN|ERROR"
   ```

2. Убедитесь, что код обновлен:
   ```bash
   cd /var/www/dmed
   git log -1 --oneline
   ```

3. Проверьте установленные библиотеки:
   ```bash
   pip list | grep -E "qrcode|Pillow"
   ```

4. Если нужно, установите qrcode-styled:
   ```bash
   pip install qrcode-styled>=0.2.0
   sudo systemctl restart dmed
   ```

